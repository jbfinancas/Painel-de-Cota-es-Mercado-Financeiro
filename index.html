<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Painel Financeiro Global</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #0f172a;
  color: white;
}

h1 {
  text-align: center;
  padding: 20px;
}

.container {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
  padding: 20px;
}

.card {
  background: #1e293b;
  padding: 15px;
  border-radius: 10px;
  text-align: center;
  transition: 0.3s;
}

.card:hover {
  transform: scale(1.03);
}

.green { color: #22c55e; }
.red { color: #ef4444; }

canvas {
  background: #1e293b;
  margin: 20px;
  border-radius: 10px;
}
</style>
</head>

<body>

<h1>ðŸ“Š Painel de Mercado Global</h1>

<div class="container" id="market"></div>

<canvas id="chart" height="100"></canvas>

<audio id="alertSound">
  <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg">
</audio>

<script>

let chart;
let historyData = {};

async function fetchData() {
  const response = await fetch("/api/quotes");
  const data = await response.json();

  const container = document.getElementById("market");
  container.innerHTML = "";

  const labels = [];
  const prices = [];

  data.quoteResponse.result.forEach(asset => {

    const percent = asset.regularMarketChangePercent || 0;
    const color = percent >= 0 ? "green" : "red";

    if (!historyData[asset.symbol]) {
      historyData[asset.symbol] = [];
    }

    historyData[asset.symbol].push(asset.regularMarketPrice);

    if (historyData[asset.symbol].length > 20) {
      historyData[asset.symbol].shift();
    }

    labels.push(asset.symbol);
    prices.push(asset.regularMarketPrice);

    if (Math.abs(percent) > 2) {
      document.getElementById("alertSound").play();
    }

    container.innerHTML += `
      <div class="card">
        <h3>${asset.symbol}</h3>
        <p>${asset.regularMarketPrice}</p>
        <p class="${color}">${percent.toFixed(2)}%</p>
      </div>
    `;
  });

  updateChart(labels, prices);
}

function updateChart(labels, prices) {
  if (chart) {
    chart.data.labels = labels;
    chart.data.datasets[0].data = prices;
    chart.update();
    return;
  }

  const ctx = document.getElementById("chart").getContext("2d");

  chart = new Chart(ctx, {
    type: "bar",
    data: {
      labels: labels,
      datasets: [{
        label: "PreÃ§os Atuais",
        data: prices
      }]
    }
  });
}

fetchData();
setInterval(fetchData, 60000);

</script>

</body>
</html>